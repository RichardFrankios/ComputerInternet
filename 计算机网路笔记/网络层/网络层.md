# 第四章 网络层

**因特网采用的设计思路 :**  网络层向上只提供简单灵活,无连接的,尽最大努力交付的数据报服务.
> 网络在发送分组时不需要事先建立连接, 每一个分组(也就是IP数据报)独立发送, 与其前后分组无关(不进行编号), 网络层不提供服务质量的保证.也就是说所所传送的分组可能出错,丢失,重复 和失序.当然也不保证分组交付的时限.

## 1. 网际协议 IP

与IP协议配套使用的还有三个重要协议:
- 地址解析协议 ARP(Address Resolution Protocol) : 负责将虚拟的IP地址转换成物理地址.
- 网际控制报文协议ICMP(Internet Control Message Protocol) : 
- 网际组管理协议IGMP(Internet Group Management Protocol) :

在TCP/IP体系中**网络层**被称为 **网际层**


![](http://i.imgur.com/5cmwcaP.png)


#### 1.1 分类的IP地址
整个因特网是一个单一的,抽象的网络. IP地址是给网络上的每一个主机分配的全球唯一的32位标识符. IP地址现在由**因特网名字和数字分配机构ICANN进行分配** 分类方法有三种 : 
1. **分类的IP地址**
2. **子网的划分**
3. **构成超网** 

#### 1.1.1 分类IP地址
分类IP地址主要由两部分组成 : 
- **网络号 :** 它标识主机所连接到的网络.
- **主机号 :** 它唯一标识该主机或路由器.一个主机号在同一个网络中是唯一的.

**这种两级的IP地址可以定义为 : {<网络号>,<主机号>}** 

**地址种类如下 : **

种类 | 网络号 | 主机号
--- | --- | ---
A类地址|0xxx xxxx (8位) | 24位
B类地址|10xx xxxx (16位)| 16位
C类地址|110x xxxx (24位)| 8位
D类地址|1110 (4bit)|多播地址 
E类地址|1111| 保留 



**一般不使用的特殊IP地址**
- `127.0.0.1` : 本地回环地址
- `网络号.全1` : 对该网络号上的所有主机进行广播.
- `全1.全1`    : 对本网络上的主机进行广播.


**IP地址和物理地址MAC的区别:**
- 物理地址是数据链路层和 物理层使用的地址.
- IP地址是网络层和以上各层使用的地址.是一种逻辑地址.
![](http://i.imgur.com/hNafFpv.png)

IP地址是在IP数据报的首部, 硬件地址是放在MAC帧的首部.在网络层及以上各层使用的都是IP, 在数据链路层及以下使用的都是MAC. 当IP数据报放入MAC帧中后整个IP数据报就成了MAC帧的数据.因此数据链路层看不见数据报IP的地址.

**在数据传输过程中可能会经过多个路由器的跳转, 在整个传输过程中源IP和目的IP地址是始终不变的. 发生变化的物理地址, 物理地址始终指向吓一跳的路由器/主机物理地址.**




## 2. 地址解析协议ARP

ARP协议要做的就是将虚拟地址(IP)转换成对应的物理地址, 在每一个路由器/主机中都有一个ARP高速缓冲表, 用来存放不同IP对应的物理地址.

**ARP的四种典型情况**
![](http://i.imgur.com/oiWmMHv.png)


1. 发送方是**主机 H1**, 要把IP数据包发送到同一个网络中的另一个**主机 H2**上, 这是H1发送ARP请求分组, 找到H2 的物理地址.
2. 发送方是**主机 H1**, 要把IP数据报发送到另一个网络上的主机H3上, H1发送ARP请求分组, 在网1中找到路由R1, 将数据报直接交付给R1.
3. 发送方是**路由器 R1** , 要把IP数据报发送到同一个网络中的主机H1上, R1 发送ARP请求分组, 获取到H1的硬件地址.
4. 发送方是**路由器 R1**, 要将IP数据报发送到不同网络 网3 中的主机H4上, R1发送ARP请求分组, 获取到路由器R2的硬件地址, 将数据报交付给R2.
 

## 3. IP数据报格式
![](http://i.imgur.com/C7chnqU.png)

从上面的结构图中可以看出IP数据报的由**IP首部** 和 **数据**两部分组成, 其中IP首部又分为**固定部分 20 字节** 和**可变部分**


### 3.1 详细介绍IP数据报首部各字段的含义
- **版本 :** 占4位, 指IP协议的版本, 通信双方的的协议版本应该保持一致. (比如IPv4, IPv6 等).
- **首部长度 :** 占 4 位 , 可表示的最大十进制数时 15, 
	- **注意1 :** 首部长度字段的单位是 **32位也就是4字节**, 因此首部的最小长度时 20/4 = 5;当首部长度为1111时达到最大长度 15 * 4 = 60字节.
	- **注意2 :** 当IP数据报的首部长度不是4 的整数倍时, 必须利用最后的填充字段加以填充. 这这样就可以保证IP数据报的数据部分永远都是从4的整数倍开始的.
	- **注意3 :** 首部可变会带来而外开销, 因此不常用.最常用的就是 `0101` 也就是 20字节.
- **区分服务 :** 占 8 位, 用来获取更好的服务,不常用.
- **总长度 :** 占 16 位 , 是指**首部和数据的长度之和** , 单位为字节, 最大数据报长度时 2 ^ 16 -1 = 65535 , 但是在现实中很少哟这么长的数据报的.
	- 在IP层的下面的数据链路层,每一种协议都规定了**数据帧中数据的最大长度**, 称为**最大传输单元MTU**当一个IP数据报封装成链路层数据帧时长度一定不能超过数据链路层规定的MTU. 否则就会被分包. 比如: 以太网是1500如果IP数据报长度超过了 1500, 就会被分片处理.
	- 进行分片后数据总长度字段表示的当前分片包的总长度.
- **标识(identification) :** 占 16 位, IP软件在存储器中维持一个计数器,每产生一个IP数据报,计数器就会加一, 并将值赋值给标识字段, 但这个表示不是序号.**当数据由于数据长度过大, 而被分片处理时这个标识字段的值就被复制到所有的数据报片的标识字段中,相同的标识值使被分片后的各个数据片段可以正确的重新组装成原来的数据报**
- **标志(flag) :** 占 3位 , 目前只有两位有用.
	- 最低位标识 **MF(More Fragment)** , MF= 1 表示后面还有分片, MF=0 表示此报文片段是分片报文片段中的最后一片报文.
	- 中间一位标记 **DF(Don't Fragment)**, 表示不能分片, 只有当DF=0时才可以进行分片.
- **片偏移 :** 占 13 位.片偏移指出,较长的分组分片后, 某片在原始分组中的相对位置, **偏移单位 : 8 字节**, 也就是说每个分片的长度一定是8字节的整数倍.


![](http://i.imgur.com/OPwv0my.png)

![](http://i.imgur.com/MFxwYj2.png)



- **生存时间(TTL) :** 占8位. 数据报在网络中可以经过的路由次数, 每经过一个路由器TTL就会 -1 当TTL为0时, 路由器就会丢弃该数据报. 最大是 255.
- **协议** 指出所携带的数据使用的是何种协议.以便使目的主机的IP层知道应将数据交给那个协议处理.
![](http://i.imgur.com/WpxMRd6.png)

- **首部校验和** 占16位 , **只检验数据报的首部, 不包括数据部分** 由于这些数据的计算分厂频繁因此不是用复杂的CRC校验. 使用简单的反码运算方式进行校验.过程如下:
	- 在发送方将IP首部划分成划分成许多 16 位 的序列. 并将校验和字段置零.
	- 用反码运算将16位字相加, 将得到的和的反码写到校验和字段.
	- 接收方收到报文后, 将首部(包括校验和)所有16位的字段的进行反码运算, 得到的和进行取反,如果正确则结果一定为0;
> 反码运算 : 就是进行简单的2进制加法, 需要注意的是,如果最高会相加有进位则结果 加1.



## 4. IP层转发分组流程

![](http://i.imgur.com/CH1o7Wy.png)

**路由表中的每一条数据主要由一下两个数据组成 : (目标地址, 下一跳地址)**

因此通过路由器我们最终可以得到下列结果 :
- IP数据报最终一定可以找到目的主机所在网络上的一个路由器(可能要经过多次间接交付).
- 只有达到最后一个路由器时, 才试图向目的主机进行直接交付.

**可以设置默认路由**

![](http://i.imgur.com/xASCTQV.png)


- 如果目的地址是本网络N1 则不需要进行跳转.
- 如果目的地址是N2网络则下一跳是路由器R2.
- 只要目的网络不是N1和N2, 一律选择默认路由器.
**在路由表中默认和直接是用0.0.0.0表示的.**






















